<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hammered Dulcimer Chord Finder</title>
    <link rel="icon" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'&gt;&lt;polygon points='12,8 20,8 28,24 4,24' fill='%23E8D5B7' stroke='%23D4AF88' stroke-width='1'/&gt;&lt;rect x='6' y='12' width='14' height='2' fill='%234A7C59'/&gt;&lt;rect x='8' y='16' width='14' height='2' fill='%234A7C59'/&gt;&lt;rect x='6' y='20' width='14' height='2' fill='%234A7C59'/&gt;&lt;/svg&gt;" type="image/svg+xml">
    <style>
        :root {
            --base-font-size: 1rem;      /* 16px base */
            --string-font-size: 1rem;    /* String labels */
            --string-height: 26px;       /* Desktop string height */
            --string-gap: 8px;           /* Gap between strings */
            --string-spacing: 34px;      /* Total string spacing (height + gap) */
            
            /* Chord colors */
            --chord1-color: #4CAF50;     /* Green */
            --chord1-light: #66BB6A;     /* Light green */
            --chord1-dark: #2E7D32;      /* Dark green */
            --chord2-color: #2196F3;     /* Blue */
            --chord2-light: #64B5F6;     /* Light blue */
            --chord2-dark: #1565C0;      /* Dark blue */
            --chord3-color: #FF9800;     /* Orange */
            --chord3-light: #FFB74D;     /* Light orange */
            --chord3-dark: #E65100;      /* Dark orange */
            
            /* UI colors */
            --background-gradient-start: #667eea;
            --background-gradient-end: #764ba2;
            --container-bg: white;
            --text-primary: #444;
            --text-secondary: #666;
            --text-tertiary: #888;
            --text-dark: #222;
            --border-color: #ddd;
            --border-light: #999;
            --button-primary: #667eea;
            --button-primary-hover: #5568d3;
            --section-bg: #f8f9fa;
            --section-bg-alt: #f0f0f0;
            --dulcimer-bg-start: #8B4513;
            --dulcimer-bg-end: #A0522D;
            --bridge-color: #654321;
            --string-default: #C0C0C0;
            --string-highlight: #E8E8E8;
            --footer-text: white;
            --key-signature-border: #DAA520;  /* Golden border for key signature */
            --key-signature-bg: #FFFFFF;      /* Darker gray background for key signature */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .instrument-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
        }


        .chord-selector {
            display: flex;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: var(--section-bg);
            border-radius: 10px;
            border-left: 4px solid var(--border-color);
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .chord-selector.chord-1 {
            border-left-color: var(--chord1-color);
        }

        .chord-selector.chord-2 {
            border-left-color: var(--chord2-color);
        }

        .chord-selector.chord-3 {
            border-left-color: var(--chord3-color);
        }

        .chord-selector.hidden {
            display: none;
        }

        .chord-selector-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
            align-items: flex-end;
        }

        .chord-selector-info {
            flex: 1;
            min-width: 200px;
        }

        .chord-selector-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-chord-btn, .remove-chord-btn {
            padding: 8px 12px;
            font-size: 1.2rem;
            min-width: 40px;
            height: 40px;
        }

        .add-chord-btn-container {
            text-align: center;
            margin-bottom: 8px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .add-chord-btn-container .add-chord-btn {
            padding: 10px 20px;
            margin-top: 4px;
            font-size: 1.3rem;
            min-width: 50px;
            height: 50px;
        }

        .add-chord-btn-container.hidden {
            display: none;
        }

        .remove-chord-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .chord-selector-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .chord-selector-notes {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        select, button {
            padding: 8px 12px;
            font-size: var(--base-font-size);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--container-bg);
            cursor: pointer;
            transition: all 0.3s;
        }

        select:focus, button:focus {
            outline: none;
            border-color: var(--button-primary);
        }

        select:hover, button:hover {
            border-color: var(--button-primary);
        }

        button {
            background: var(--button-primary);
            color: var(--container-bg);
            border: none;
            font-weight: 600;
        }

        button:hover {
            background: var(--button-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .dulcimer-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background: linear-gradient(to bottom, var(--dulcimer-bg-start) 0%, var(--dulcimer-bg-end) 100%);
            border-radius: 15px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            gap: 30px;
            min-height: 600px;
        }

        .bridge-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bridge-label {
            text-align: center;
            font-weight: bold;
            color: var(--footer-text);
            margin-bottom: 15px;
            font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            writing-mode: horizontal-tb;
        }

        .bridge {
            position: relative;
            background: var(--bridge-color);
            width: 8px;
            height: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .bridge-marker {
            width: 12px;
            height: 12px;
            background: var(--container-bg);
            border-radius: 50%;
            border: 1px solid var(--text-primary);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .strings-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-start;
        }

        .bridge-section {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .bridge-section.low-bass {
            align-items: flex-start;
        }

        .bridge-section.low-bass .strings-column {
            /* Offset by 9 strings: 9 Ã— (26px height + 8px gap) = 306px */
            padding-top: 306px;
        }

        .strings-left {
            order: 1;
        }

        .bridge-middle {
            order: 2;
        }

        .strings-right {
            order: 3;
        }

        .string {
            width: 65px;
            height: 26px;
            background: linear-gradient(to right, var(--string-default) 0%, var(--string-highlight) 50%, var(--string-default) 100%);
            border: 1px solid var(--border-light);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--string-font-size);
            font-weight: bold;
            color: var(--text-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .string:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .string:active {
            transform: scale(0.98);
        }

        /* Single chord highlighting - full color */
        .string.chord-1 {
            background: linear-gradient(to bottom, var(--chord1-color) 0%, var(--chord1-light) 50%, var(--chord1-color) 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--container-bg);
            font-weight: bold;
        }

        .string.chord-2 {
            background: linear-gradient(to bottom, var(--chord2-color) 0%, var(--chord2-light) 50%, var(--chord2-color) 100%) !important;
            border-color: var(--chord2-dark);
            color: var(--container-bg);
            font-weight: bold;
        }

        .string.chord-3 {
            background: linear-gradient(to bottom, var(--chord3-color) 0%, var(--chord3-light) 50%, var(--chord3-color) 100%) !important;
            border-color: var(--chord3-dark);
            color: var(--container-bg);
            font-weight: bold;
        }

        /* Two chords active - single chord matches */
        .string.chord-1-only-of-2 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-2-only-of-2 {
            background: linear-gradient(to right, 
                var(--string-default) 0% 75%, 
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord2-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        /* Two chords active - both match */
        .string.chord-1-2-of-2 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 75%, 
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-1-3-of-2 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 75%, 
                var(--chord3-color) 75% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-2-3-of-2 {
            background: linear-gradient(to right, 
                var(--chord2-color) 0% 25%, 
                var(--string-default) 25% 75%, 
                var(--chord3-color) 75% 100%) !important;
            border-color: var(--chord2-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        /* Three chords active - single chord matches */
        .string.chord-1-only-of-3 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-2-only-of-3 {
            background: linear-gradient(to right, 
                var(--string-default) 0% 75%, 
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord2-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-3-only-of-3 {
            background: linear-gradient(to right, 
                var(--string-default) 0% 37.5%,
                var(--chord3-color) 37.5% 62.5%,
                var(--string-default) 62.5% 100%) !important;
            border-color: var(--chord3-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        /* Three chords active - two chord matches */
        .string.chord-1-2-of-3 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 75%, 
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-1-3-of-3 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 37.5%,
                var(--chord3-color) 37.5% 62.5%,
                var(--string-default) 62.5% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        .string.chord-2-3-of-3 {
            background: linear-gradient(to right, 
                var(--string-default) 0% 37.5%,
                var(--chord3-color) 37.5% 62.5%,
                var(--string-default) 62.5% 75%,
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord2-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        /* Three chords active - all three match */
        .string.chord-1-2-3-of-3 {
            background: linear-gradient(to right, 
                var(--chord1-color) 0% 25%, 
                var(--string-default) 25% 37.5%,
                var(--chord3-color) 37.5% 62.5%,
                var(--string-default) 62.5% 75%,
                var(--chord2-color) 75% 100%) !important;
            border-color: var(--chord1-dark);
            color: var(--text-dark);
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .note-label {
            position: absolute;
            font-size: 0.75rem;
            color: var(--text-secondary);
            bottom: 2px;
            opacity: 0.7;
        }

        /* Key signature highlighting */
        .string.in-key-signature {
            background: var(--key-signature-bg);
            border: 3px solid var(--key-signature-border);
            box-shadow: 0 0 4px 1px var(--key-signature-border);
            box-sizing: border-box;
        }

        .string.in-key-signature .note-label {
            color: var(--text-primary);
            font-weight: bold;
            bottom: 0px;
        }

        @media (max-width: 768px) {
            :root {
                --string-height: 22px;
                --string-spacing: 30px;  /* 22px height + 8px gap */
            }

            h1 {
                font-size: 1.5rem;
            }

            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }

            .instrument-controls .control-group {
                flex: 0 1 auto;
                min-width: 0;
            }

            .instrument-controls .control-group:first-child {
                flex: 1 1 100%;
            }

            .control-group {
                flex: 1 1 calc(50% - 5px);
                min-width: 150px;
            }

            select, button {
                width: 100%;
            }

            /* Keep Root Note and Chord Type side by side on mobile */
            .chord-selector-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .chord-selector-controls .control-group:nth-child(1) {
                flex: 0 0 calc(33.33% - 7px);
                min-width: 0;
            }

            .chord-selector-controls .control-group:nth-child(2) {
                flex: 0 0 calc(66.67% - 3px);
                min-width: 0;
            }

            .chord-selector-info {
                flex: 1 1 100%;
            }

            .dulcimer-container {
                padding: 20px 10px;
                gap: 15px;
                min-height: 500px;
            }

            .string {
                width: 52px;
                height: 22px;
                font-size: 0.75rem;
            }

            .bridge-label {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            :root {
                --string-height: 20px;
                --string-spacing: 28px;  /* 20px height + 8px gap */
            }

            .container {
                padding: 15px;
            }

            .string {
                width: 42px;
                height: 20px;
                font-size: 0.65rem;
            }

            .dulcimer-container {
                gap: 10px;
                padding: 15px 5px;
            }

            .bridge-section {
                gap: 8px;
            }

            .bridge-label {
                font-size: 0.75rem;
            }

            /* Make play buttons more compact on mobile */
            .play-chord-btn {
                padding: 6px 8px;
                font-size: 0.85rem;
                white-space: nowrap;
                min-width: auto;
                flex-shrink: 1;
            }

            .remove-chord-btn {
                padding: 6px 8px;
                font-size: 0.85rem;
                min-width: auto;
                width: 32px;
                height: auto;
                flex-shrink: 0;
            }

            .chord-selector-buttons {
                gap: 4px;
            }

            .chord-selector-buttons .remove-chord-btn {
                margin-left: 80%;
            }

            .add-chord-btn-container .add-chord-btn {
                width: 100%;
                max-width: none;
            }
        }

        .footer {
            text-align: center;
            color: var(--footer-text);
            margin-top: 20px;
            font-size: 0.9rem;
        }

        /* Footer links styling */
        .footer-link {
            color: var(--footer-text);
            text-decoration: underline;
            margin: 0 10px;
        }

        /* Request layout option styling */
        .request-layout-option {
            font-style: italic;
            color: var(--button-primary);
        }

        /* No instrument message styling */
        .no-instrument-message {
            text-align: center;
            color: var(--footer-text);
            font-size: 1.2rem;
            padding: 50px;
        }

        /* Validation warning banner styling */
        .validation-warning-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: var(--container-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #ff4757;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .validation-warning-banner h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .validation-warning-banner ul {
            margin: 10px 0 0 20px;
            padding: 0;
            list-style: decimal;
        }

        .validation-warning-banner li {
            margin: 5px 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .validation-warning-banner .warning-icon {
            font-size: 1.3rem;
        }

        /* Sound bank button styling */
        .sound-bank-button {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            color: var(--button-primary);
            padding: 8px 12px;
            font-size: 1.2rem;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-bank-button:hover {
            background: var(--section-bg);
            border-color: var(--button-primary);
        }

        .control-group-with-button {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }

        /* Sound bank modal styling */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--container-bg);
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--section-bg-alt);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--border-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--section-bg-alt);
            color: var(--text-primary);
            transform: none;
            box-shadow: none;
        }

        .sound-bank-list {
            overflow-y: auto;
            flex: 1;
        }

        .sound-bank-category-header {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--button-primary);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--button-primary);
        }

        .sound-bank-category-header:first-child {
            margin-top: 0;
        }

        .sound-bank-item {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--container-bg);
        }

        .sound-bank-item:hover {
            border-color: var(--button-primary);
            background: var(--section-bg);
        }

        .sound-bank-item.active {
            background: var(--button-primary);
            border-color: var(--button-primary);
            color: var(--container-bg);
        }

        .sound-bank-item.active:hover {
            background: var(--button-primary-hover);
            border-color: var(--button-primary-hover);
        }

        .sound-bank-name {
            font-weight: 600;
            font-size: 1rem;
        }

        /* iOS Audio Initialization Overlay */
        .audio-init-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        .audio-init-overlay.show {
            display: flex;
        }

        .audio-init-button {
            padding: 20px 40px;
            font-size: 1.2rem;
            background: var(--button-primary);
            color: var(--container-bg);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
            transition: all 0.3s;
        }

        .audio-init-button:hover {
            background: var(--button-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.8);
        }

        .audio-init-text {
            color: var(--footer-text);
            font-size: 1.1rem;
            text-align: center;
            max-width: 400px;
            padding: 0 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@latest/dist/soundfont-player.min.js"></script>
    <script>
    const config = {
        // Google Form URL for requesting new instrument layouts
        googleFormUrl: "https://docs.google.com/forms/d/e/1FAIpQLSdiFmni2nnSVDc_xM-JiW5cav6RqslKIAf4dia1EV1u9_K0oA/viewform?usp=dialog",
        
        // Other configuration settings can be added here as needed
        // For example:
        // githubIssuesUrl: "https://github.com/dwballance/Dulcimer-Chord-Finder/issues/new",
        // supportEmail: "support@example.com"
        note_gain: 0.8 // Gain for note playback (0.0 to 1.0)
    };
    </script>
</head>
<body>
    <!-- Audio Initialization Overlay for iOS -->
    <div class="audio-init-overlay" id="audio-init-overlay">
        <div class="audio-init-text">
            Tap below to enable sound<br>
            <small>(Required for iOS devices)</small>
        </div>
        <button class="audio-init-button" id="audio-init-button">ðŸ”Š Enable Sound</button>
    </div>

    <div class="container">
        <h1>Hammered Dulcimer Chord Finder</h1>
        
        <!-- Instrument and Sound Controls -->
        <div class="instrument-controls">
            <div class="control-group">
                <label for="instrument-select">Instrument</label>
                <select id="instrument-select">
                    <!-- Populated by JavaScript -->
                </select>
            </div>

            <div class="control-group">
                <label for="sharp-flat-select">â™­/â™¯</label>
                <select id="sharp-flat-select">
                    <option value="sharp">â™¯</option>
                    <option value="flat">â™­</option>
                </select>
            </div>

            <div class="control-group">
                <label for="key-signature-select">Key Sig</label>
                <select id="key-signature-select">
                    <option value="none">None</option>
                    <!-- Populated by JavaScript -->
                </select>
            </div>

            <div class="control-group">
                <label for="sound-bank-select">Sound</label>
                <div class="control-group-with-button">
                    <button id="sound-bank-button" class="sound-bank-button" title="Change Sound Bank">ðŸŽµ</button>
                </div>
            </div>
        </div>

        <!-- Chord Selectors -->
        <div class="chord-selectors">
            <!-- Chord 1 (Green) - Always visible -->
            <div class="chord-selector chord-1" data-chord-index="0">
                <div class="chord-selector-controls">
                    <div class="control-group">
                        <label for="root-note-1">Root Note</label>
                        <select id="root-note-1" class="root-note-select">
                            <option value="C">C</option>
                            <option value="C#">Câ™¯/Dâ™­</option>
                            <option value="D">D</option>
                            <option value="D#">Dâ™¯/Eâ™­</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">Fâ™¯/Gâ™­</option>
                            <option value="G">G</option>
                            <option value="G#">Gâ™¯/Aâ™­</option>
                            <option value="A">A</option>
                            <option value="A#">Aâ™¯/Bâ™­</option>
                            <option value="B">B</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="chord-type-1">Chord Type</label>
                        <select id="chord-type-1" class="chord-type-select">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="diminished">Diminished</option>
                            <option value="augmented">Augmented</option>
                            <option value="sus2">Sus2</option>
                            <option value="sus4">Sus4</option>
                            <option value="power5">5 (Power Chord)</option>
                            <option value="major6">Major 6th</option>
                            <option value="minor6">Minor 6th</option>
                            <option value="major7">Major 7th</option>
                            <option value="minor7">Minor 7th</option>
                            <option value="dominant7">Dominant 7th</option>
                            <option value="diminished7">Diminished 7th</option>
                            <option value="7sus4">7sus4</option>
                            <option value="minor7b5">Minor 7th â™­5</option>
                            <option value="7b5">7th â™­5</option>
                            <option value="7b9">7th â™­9</option>
                            <option value="7sharp9">7th â™¯9</option>
                            <option value="major9">Major 9th</option>
                            <option value="minor9">Minor 9th</option>
                            <option value="dominant9">Dominant 9th</option>
                            <option value="add9">Add9</option>
                            <option value="6add9">6/9</option>
                            <option value="major11">Major 11th</option>
                            <option value="minor11">Minor 11th</option>
                            <option value="dominant11">Dominant 11th</option>
                            <option value="major13">Major 13th</option>
                            <option value="minor13">Minor 13th</option>
                            <option value="dominant13">Dominant 13th</option>
                        </select>
                    </div>

                    <div class="chord-selector-info">
                        <div class="chord-selector-notes" id="chord-notes-1">Notes: C, E, G</div>
                    </div>
                </div>

                <div class="chord-selector-buttons">
                    <button id="play-chord-1-fast" class="play-chord-btn">â–¶ Fast</button>
                    <button id="play-chord-1-slow" class="play-chord-btn">â–¶ Slow</button>
                    <button id="remove-chord-1-btn" class="remove-chord-btn">âˆ’</button>
                </div>
            </div>

            <!-- Chord 2 (Blue) - Hidden by default -->
            <div class="chord-selector chord-2 hidden" data-chord-index="1">
                <div class="chord-selector-controls">
                    <div class="control-group">
                        <label for="root-note-2">Root Note</label>
                        <select id="root-note-2" class="root-note-select">
                            <option value="C">C</option>
                            <option value="C#">Câ™¯/Dâ™­</option>
                            <option value="D">D</option>
                            <option value="D#">Dâ™¯/Eâ™­</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">Fâ™¯/Gâ™­</option>
                            <option value="G">G</option>
                            <option value="G#">Gâ™¯/Aâ™­</option>
                            <option value="A">A</option>
                            <option value="A#">Aâ™¯/Bâ™­</option>
                            <option value="B">B</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="chord-type-2">Chord Type</label>
                        <select id="chord-type-2" class="chord-type-select">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="diminished">Diminished</option>
                            <option value="augmented">Augmented</option>
                            <option value="sus2">Sus2</option>
                            <option value="sus4">Sus4</option>
                            <option value="power5">5 (Power Chord)</option>
                            <option value="major6">Major 6th</option>
                            <option value="minor6">Minor 6th</option>
                            <option value="major7">Major 7th</option>
                            <option value="minor7">Minor 7th</option>
                            <option value="dominant7">Dominant 7th</option>
                            <option value="diminished7">Diminished 7th</option>
                            <option value="7sus4">7sus4</option>
                            <option value="minor7b5">Minor 7th â™­5</option>
                            <option value="7b5">7th â™­5</option>
                            <option value="7b9">7th â™­9</option>
                            <option value="7sharp9">7th â™¯9</option>
                            <option value="major9">Major 9th</option>
                            <option value="minor9">Minor 9th</option>
                            <option value="dominant9">Dominant 9th</option>
                            <option value="add9">Add9</option>
                            <option value="6add9">6/9</option>
                            <option value="major11">Major 11th</option>
                            <option value="minor11">Minor 11th</option>
                            <option value="dominant11">Dominant 11th</option>
                            <option value="major13">Major 13th</option>
                            <option value="minor13">Minor 13th</option>
                            <option value="dominant13">Dominant 13th</option>
                        </select>
                    </div>

                    <div class="chord-selector-info">
                        <div class="chord-selector-notes" id="chord-notes-2">Notes: C, E, G</div>
                    </div>
                </div>

                <div class="chord-selector-buttons">
                    <button id="play-chord-2-fast" class="play-chord-btn">â–¶ Fast</button>
                    <button id="play-chord-2-slow" class="play-chord-btn">â–¶ Slow</button>
                    <button id="remove-chord-2-btn" class="remove-chord-btn">âˆ’</button>
                </div>
            </div>

            <!-- Chord 3 (Orange) - Hidden by default -->
            <div class="chord-selector chord-3 hidden" data-chord-index="2">
                <div class="chord-selector-controls">
                    <div class="control-group">
                        <label for="root-note-3">Root Note</label>
                        <select id="root-note-3" class="root-note-select">
                            <option value="C">C</option>
                            <option value="C#">Câ™¯/Dâ™­</option>
                            <option value="D">D</option>
                            <option value="D#">Dâ™¯/Eâ™­</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">Fâ™¯/Gâ™­</option>
                            <option value="G">G</option>
                            <option value="G#">Gâ™¯/Aâ™­</option>
                            <option value="A">A</option>
                            <option value="A#">Aâ™¯/Bâ™­</option>
                            <option value="B">B</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="chord-type-3">Chord Type</label>
                        <select id="chord-type-3" class="chord-type-select">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="diminished">Diminished</option>
                            <option value="augmented">Augmented</option>
                            <option value="sus2">Sus2</option>
                            <option value="sus4">Sus4</option>
                            <option value="power5">5 (Power Chord)</option>
                            <option value="major6">Major 6th</option>
                            <option value="minor6">Minor 6th</option>
                            <option value="major7">Major 7th</option>
                            <option value="minor7">Minor 7th</option>
                            <option value="dominant7">Dominant 7th</option>
                            <option value="diminished7">Diminished 7th</option>
                            <option value="7sus4">7sus4</option>
                            <option value="minor7b5">Minor 7th â™­5</option>
                            <option value="7b5">7th â™­5</option>
                            <option value="7b9">7th â™­9</option>
                            <option value="7sharp9">7th â™¯9</option>
                            <option value="major9">Major 9th</option>
                            <option value="minor9">Minor 9th</option>
                            <option value="dominant9">Dominant 9th</option>
                            <option value="add9">Add9</option>
                            <option value="6add9">6/9</option>
                            <option value="major11">Major 11th</option>
                            <option value="minor11">Minor 11th</option>
                            <option value="dominant11">Dominant 11th</option>
                            <option value="major13">Major 13th</option>
                            <option value="minor13">Minor 13th</option>
                            <option value="dominant13">Dominant 13th</option>
                        </select>
                    </div>

                    <div class="chord-selector-info">
                        <div class="chord-selector-notes" id="chord-notes-3">Notes: C, E, G</div>
                    </div>
                </div>

                <div class="chord-selector-buttons">
                    <button id="play-chord-3-fast" class="play-chord-btn">â–¶ Fast</button>
                    <button id="play-chord-3-slow" class="play-chord-btn">â–¶ Slow</button>
                    <button id="remove-chord-3-btn" class="remove-chord-btn">âˆ’</button>
                </div>
            </div>
        </div>

        <!-- Add Chord Button (below all selectors) -->
        <div class="add-chord-btn-container" id="add-chord-btn-container">
            <button id="add-chord-btn" class="add-chord-btn">+ Add Chord</button>
        </div>

        <div class="dulcimer-container" id="dulcimer">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <div class="footer">
        Hammered Dulcimer Chord Finder v1.1.0 â€¢ Click strings to hear notes<br>
        <a href="${config.googleFormUrl}" 
           target="_blank" 
           rel="noopener noreferrer"
           class="footer-link">
           Request an Instrument Layout</a>
        â€¢ <a href="https://github.com/dwballance/Dulcimer-Chord-Finder/issues/new?template=bug-report.md" 
           target="_blank"
           rel="noopener noreferrer" 
           class="footer-link">
            Report Bug</a>
        â€¢ <a href="https://github.com/dwballance/Dulcimer-Chord-Finder" 
           target="_blank"
           rel="noopener noreferrer" 
           class="footer-link">
            View Source
        </a>
    </div>

    <script>
        // Note frequencies (A4 = 440Hz)
        const noteFrequencies = {
            'C': [16.35, 32.70, 65.41, 130.81, 261.63, 523.25, 1046.50, 2093.00],
            'C#': [17.32, 34.65, 69.30, 138.59, 277.18, 554.37, 1108.73, 2217.46],
            'D': [18.35, 36.71, 73.42, 146.83, 293.66, 587.33, 1174.66, 2349.32],
            'D#': [19.45, 38.89, 77.78, 155.56, 311.13, 622.25, 1244.51, 2489.02],
            'E': [20.60, 41.20, 82.41, 164.81, 329.63, 659.25, 1318.51, 2637.02],
            'F': [21.83, 43.65, 87.31, 174.61, 349.23, 698.46, 1396.91, 2793.83],
            'F#': [23.12, 46.25, 92.50, 185.00, 369.99, 739.99, 1479.98, 2959.96],
            'G': [24.50, 49.00, 98.00, 196.00, 392.00, 783.99, 1567.98, 3135.96],
            'G#': [25.96, 51.91, 103.83, 207.65, 415.30, 830.61, 1661.22, 3322.44],
            'A': [27.50, 55.00, 110.00, 220.00, 440.00, 880.00, 1760.00, 3520.00],
            'A#': [29.14, 58.27, 116.54, 233.08, 466.16, 932.33, 1864.66, 3729.31],
            'B': [30.87, 61.74, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.07]
        };

        const markerOffset = 6; // pixels to center markers on strings

        // Multi-chord state tracking (up to 3 chords)
        const chordStates = [
            { root: 'C', type: 'major', notes: [], active: true },   // Chord 1 (Green)
            { root: 'C', type: 'major', notes: [], active: false },  // Chord 2 (Blue)
            { root: 'C', type: 'major', notes: [], active: false }   // Chord 3 (Orange)
        ];

        // Available soundfonts from soundfont-player library
        // Organized by category for better UX
        const soundBanks = [
            // Percussion/Mallet
            { id: 'dulcimer', name: 'Dulcimer', category: 'Percussion' },
            { id: 'kalimba', name: 'Kalimba', category: 'Percussion' },
            { id: 'marimba', name: 'Marimba', category: 'Percussion' },
            { id: 'xylophone', name: 'Xylophone', category: 'Percussion' },
            { id: 'vibraphone', name: 'Vibraphone', category: 'Percussion' },
            { id: 'glockenspiel', name: 'Glockenspiel', category: 'Percussion' },
            { id: 'tubular_bells', name: 'Tubular Bells', category: 'Percussion' },
            { id: 'music_box', name: 'Music Box', category: 'Percussion' },
            { id: 'timpani', name: 'Timpani', category: 'Percussion' },
            { id: 'steel_drums', name: 'Steel Drums', category: 'Percussion' },
            
            // Piano
            { id: 'acoustic_grand_piano', name: 'Acoustic Grand Piano', category: 'Piano' },
            { id: 'bright_acoustic_piano', name: 'Bright Acoustic Piano', category: 'Piano' },
            { id: 'electric_grand_piano', name: 'Electric Grand Piano', category: 'Piano' },
            { id: 'honkytonk_piano', name: 'Honky-tonk Piano', category: 'Piano' },
            { id: 'electric_piano_1', name: 'Electric Piano 1', category: 'Piano' },
            { id: 'electric_piano_2', name: 'Electric Piano 2', category: 'Piano' },
            { id: 'harpsichord', name: 'Harpsichord', category: 'Piano' },
            { id: 'clavinet', name: 'Clavinet', category: 'Piano' },
            
            // Strings
            { id: 'violin', name: 'Violin', category: 'Strings' },
            { id: 'viola', name: 'Viola', category: 'Strings' },
            { id: 'cello', name: 'Cello', category: 'Strings' },
            { id: 'contrabass', name: 'Contrabass', category: 'Strings' },
            { id: 'acoustic_guitar_nylon', name: 'Acoustic Guitar (Nylon)', category: 'Strings' },
            { id: 'acoustic_guitar_steel', name: 'Acoustic Guitar (Steel)', category: 'Strings' },
            { id: 'electric_guitar_jazz', name: 'Electric Guitar (Jazz)', category: 'Strings' },
            { id: 'electric_guitar_clean', name: 'Electric Guitar (Clean)', category: 'Strings' },
            { id: 'pizzicato_strings', name: 'Pizzicato Strings', category: 'Strings' },
            { id: 'orchestral_harp', name: 'Orchestral Harp', category: 'Strings' },
            { id: 'string_ensemble_1', name: 'String Ensemble 1', category: 'Strings' },
            { id: 'string_ensemble_2', name: 'String Ensemble 2', category: 'Strings' },
            { id: 'banjo', name: 'Banjo', category: 'Strings' },
            { id: 'shamisen', name: 'Shamisen', category: 'Strings' },
            { id: 'koto', name: 'Koto', category: 'Strings' },
            { id: 'sitar', name: 'Sitar', category: 'Strings' },
            
            // Woodwinds
            { id: 'flute', name: 'Flute', category: 'Woodwinds' },
            { id: 'piccolo', name: 'Piccolo', category: 'Woodwinds' },
            { id: 'recorder', name: 'Recorder', category: 'Woodwinds' },
            { id: 'pan_flute', name: 'Pan Flute', category: 'Woodwinds' },
            { id: 'blown_bottle', name: 'Blown Bottle', category: 'Woodwinds' },
            { id: 'shakuhachi', name: 'Shakuhachi', category: 'Woodwinds' },
            { id: 'whistle', name: 'Whistle', category: 'Woodwinds' },
            { id: 'ocarina', name: 'Ocarina', category: 'Woodwinds' },
            { id: 'oboe', name: 'Oboe', category: 'Woodwinds' },
            { id: 'english_horn', name: 'English Horn', category: 'Woodwinds' },
            { id: 'bassoon', name: 'Bassoon', category: 'Woodwinds' },
            { id: 'clarinet', name: 'Clarinet', category: 'Woodwinds' },
            { id: 'soprano_sax', name: 'Soprano Sax', category: 'Woodwinds' },
            { id: 'alto_sax', name: 'Alto Sax', category: 'Woodwinds' },
            { id: 'tenor_sax', name: 'Tenor Sax', category: 'Woodwinds' },
            { id: 'baritone_sax', name: 'Baritone Sax', category: 'Woodwinds' },
            
            // Brass
            { id: 'trumpet', name: 'Trumpet', category: 'Brass' },
            { id: 'trombone', name: 'Trombone', category: 'Brass' },
            { id: 'tuba', name: 'Tuba', category: 'Brass' },
            { id: 'french_horn', name: 'French Horn', category: 'Brass' },
            { id: 'brass_section', name: 'Brass Section', category: 'Brass' },
            
            // Organ
            { id: 'drawbar_organ', name: 'Drawbar Organ', category: 'Organ' },
            { id: 'percussive_organ', name: 'Percussive Organ', category: 'Organ' },
            { id: 'rock_organ', name: 'Rock Organ', category: 'Organ' },
            { id: 'church_organ', name: 'Church Organ', category: 'Organ' },
            { id: 'reed_organ', name: 'Reed Organ', category: 'Organ' },
            { id: 'accordion', name: 'Accordion', category: 'Organ' },
            { id: 'harmonica', name: 'Harmonica', category: 'Organ' },
            { id: 'tango_accordion', name: 'Tango Accordion', category: 'Organ' },
            
            // Synth
            { id: 'celesta', name: 'Celesta', category: 'Synth' },
            { id: 'lead_1_square', name: 'Square Lead', category: 'Synth' },
            { id: 'lead_2_sawtooth', name: 'Sawtooth Lead', category: 'Synth' },
            { id: 'pad_1_new_age', name: 'New Age Pad', category: 'Synth' },
            { id: 'pad_2_warm', name: 'Warm Pad', category: 'Synth' },
            { id: 'fx_1_rain', name: 'Rain FX', category: 'Synth' },
            { id: 'fx_2_soundtrack', name: 'Soundtrack FX', category: 'Synth' },
            { id: 'fx_3_crystal', name: 'Crystal FX', category: 'Synth' },
            { id: 'fx_4_atmosphere', name: 'Atmosphere FX', category: 'Synth' },
            
            // Bass
            { id: 'acoustic_bass', name: 'Acoustic Bass', category: 'Bass' },
            { id: 'electric_bass_finger', name: 'Electric Bass (Finger)', category: 'Bass' },
            { id: 'electric_bass_pick', name: 'Electric Bass (Pick)', category: 'Bass' },
            { id: 'fretless_bass', name: 'Fretless Bass', category: 'Bass' },
            { id: 'slap_bass_1', name: 'Slap Bass 1', category: 'Bass' },
            { id: 'slap_bass_2', name: 'Slap Bass 2', category: 'Bass' },
            { id: 'synth_bass_1', name: 'Synth Bass 1', category: 'Bass' },
            { id: 'synth_bass_2', name: 'Synth Bass 2', category: 'Bass' }
        ];

        // Instrument configurations
        // "defualt: true" indicates instruments to show by default in the dropdown
        // Bridges are rendered left-to-right in array order
        const instruments = [
           {
                id: 'standard-15/14',
                name: '*Standard 15/14',
                default: true,
                bridges: [
                    {
                        name: 'Treble',
                        notesLeft: ['D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [1,4,7,10,13] // 
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [1,4,7,10,13] // 
                    }
                ]
            },
             {
                id: 'clound-nine-17-16-8',
                name: 'Cloud Nine 17/16/8',
                default: true,
                bridges: [
                    {
                        name: 'Low Bass',
                        notesRight: ['Bb3', 'F3', 'D#3', 'C#3', 'C3', 'B2', 'A2', 'G2'],
                        verticalOffset: 9, // 9 strings
                        markers: [1, 4, 7] // F3, C3, E2
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['G6', 'E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['C#6', 'Bb6', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // F5, C5, G4, D4, A3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['G#5', 'D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            {
                id: 'clound-nine-20-19-8',
                name: 'Cloud Nine 20/19/8',
                default: true,
                bridges: [
                    {
                        name: 'Low Bass',
                        notesRight: ['F3', 'C3', 'Bb2', 'G#2', 'G2', 'F#2', 'E2', 'D2'],
                        verticalOffset: 9, // 9 strings
                        markers: [1, 4, 7] // F3, C3, E2
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['G6', 'E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4','C#4', 'B3', 'A#3'],
                        notesRight: ['C#6', 'Bb6', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3', 'F#3', 'E3', 'D#3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15, 18] // F5, C5, G4, D4, A3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['G#5', 'D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'C#3', 'B2', 'A2'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15, 18] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
           {
                id: 'davids-spinet-1615',
                name: 'David\'s Dulcimers Spinet 16/15',
                default: true,
                bridges: [
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['A5', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0, // 10 strings
                        markers: [2, 5, 8, 11, 14] // 
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] // Bb4, F4, C4, G3, D3
                    }
                ],
            },
            {
                id: 'davids-grand',
                name: 'David\'s Dulcimers Extended Range Grand 16/15/7',
                default: true,
                bridges: [
                    {
                        name: 'Left Extended Range',
                        notesRight: ['G6', 'F#6', 'D#6'],
                        verticalOffset: 0,
                        markers: [] // No markers
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0, // 10 strings
                        markers: [1,4,7,10,13] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'A3'],
                        verticalOffset: 0,
                        markers: [1,4,7,10,13] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Right Extended Range',
                        notesLeft: ['Bb3', 'C3', 'G2', 'D2'],
                        verticalOffset: 0,
                        markers: [] // No markers
                    }
                ],
            },
            {
                id: 'dusty-strings-570',
                name: 'Dusty Strings 570 16/15/8/8',
                default: true,
                bridges: [
                    {
                        name: 'Left Chromatic and Super Bass',
                        notesRight: ['D#6', 'C#6', null, null, null, null, null, null, 'Bb3', 'F3', 'D#3', 'C#3', 'C3', 'B2', 'A2', 'G2'],
                        verticalOffset: 0, // 10 strings
                        markers: [9,12,15] // Mark white keys
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'G#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Right Super Bass',
                        notesLeft: ['Bb3', 'F3', 'D#3', 'C#3', 'C3', 'B2', 'A2', 'G2'],
                        verticalOffset: 7, // 10 strings
                        markers: [1,4,7] // Mark white keys
                    }
                ]
            },
            {
                id: 'dusty-strings-670',
                name: 'Dusty Strings 670 19/18/9/9',
                default: true,
                bridges: [
                    {
                        name: 'Left Chromatic and Super Bass',
                        notesRight: ['D#6', 'C#6', null, null, null, null, null, null, null, 'F3', 'C3', 'G2', 'F#2', 'E2', 'D2', 'C#2', 'B1', 'A1'],
                        verticalOffset: 0, // 10 strings
                        markers: [9,10,11,14,17] // Mark white keys
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4', 'C#4', 'B3', 'A#3'],
                        notesRight: ['Bb5', 'G#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3', 'F#3', 'E3', 'D#3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14, 17] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'C#3', 'B2', 'A2'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14, 17] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Right Super Bass',
                        notesLeft: ['F3', 'C3', 'G2', 'F#2', 'E2', 'D2', 'C#2', 'B1', 'A1'],
                        verticalOffset: 9, // 10 strings
                        markers: [0,1,2,5,8] // Mark white keys
                    }
                ]
            },
           {
                id: 'dusty-strings-d45',
                name: 'Dusty Strings D45 16/15',
                default: true,
                bridges: [
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['A5', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            
            {
                id: 'dusty-strings-overture',
                name: 'Dusty Strings Overture 16/15',
                default: true,
                bridges: [
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['A5', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            {
                id: 'dusty-strings-pd40',
                name: 'Dusty Strings PD40 3 1/2 octave chromatic',
                default: true,
                bridges: [
                    {
                        name: 'Left Bass',
                        notesRight: ['F3', 'Eb3', 'C#3', 'B2', 'A2', 'G2'],
                        verticalOffset: 10, // 10 strings
                        markers: [0, 3, 4, 5] // Mark white keys
                    },
                    {
                        name: 'Center Left Side',
                        notesLeft: ['C#6', 'B5', 'A5', 'G5', 'F5', 'Eb5', 'C#5', 'B4', 'A4', 'G4', 'F4', 'Eb4', 'C#4', 'B3', 'A3', 'G3'],
                        verticalOffset: 0,
                        markers: [1,2,3,4,7,8,9,10,13,14,15] // Mark white keys
                    },
                    {
                        name: 'Right Right Side',
                        notesRight: ['D6', 'C6', 'Bb5', 'G#5', 'F#5', 'E5', 'D4', 'C5', 'Bb4', 'G#4', 'F#4', 'E4', 'D4', 'C4', 'Bb3', 'G#3'],
                        verticalOffset: 0,
                        markers: [0,1,5,6,7,11,12,13] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Right Bass',
                        notesLeft: ['F#3', 'E3', 'D3', 'C3', 'A#2', 'G#2'],
                        verticalOffset: 10, // 10 strings
                        markers: [1, 2, 3] 
                    }
                ]
            },
            {
                id: 'james-jones-3-16-18-9',
                name: 'James Jones Custom Performance - 3/16/18/9',
                default: true,
                bridges: [
                    {
                        name:'High treble',
                        notesRight: ['F6', 'D#6', 'C#6'],
                        verticalOffset: 0,
                        markers: [0] // A6, G6
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['A#5', 'G#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] // F6, F5, C5, G4, D4, A3, E3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C#5', 'A#4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'C#3', 'B2', 'A2'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14,17] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Low Bass',
                        notesLeft: ['A#3', 'F3', 'D#3', 'C3', 'A#2', 'G2', 'F#2', 'E2', 'D2'],
                        verticalOffset: 9, // 8 strings
                        markers: [1,3,5,8] // Bb3, F3, C3, G2, D2, A1
                    }
                ]
            },
            {
                id: 'masterworks-dulciforte-xr-r',
                name: 'Masterworks Dulciforte 20/20 XR-R',
                default: true,
                bridges: [
                    {
                        name:'High treble',
                        notesRight: ['A6', 'G#6', 'G6', 'F#6', 'D#6', 'C#6', 'G#5'],
                        verticalOffset: 0,
                        markers: [0, 2] // A6, G6
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['F6', 'E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4', 'C#4', 'B3', 'A#3'],
                        notesRight: ['Bb5', 'A5', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3', 'F#3', 'E3', 'D#3'],
                        verticalOffset: 0,
                        markers: [0, 3, 6, 9, 12, 15, 18] // F6, F5, C5, G4, D4, A3, E3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['Eb5', 'D5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'C#3', 'B2', 'A2', 'G#2'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Low Bass',
                        notesLeft: ['Bb3', 'F3', 'D#3', 'C3', 'Bb2', 'G2', 'F#2', 'E2', 'D2', 'C#2', 'B1', 'A1'],
                        verticalOffset: 8, // 8 strings
                        markers: [0, 1, 3, 5, 8, 11] // Bb3, F3, C3, G2, D2, A1
                    }
                ]
            },
            {
                id: 'masterworks-pioneer',
                name: 'Masterworks Pioneer 16/15p',
                default: true,
                bridges: [
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'G#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] 
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] 
                    }
                ]
            },
            {
                id: 'masterworks-russell-cook-1717xr',
                name: 'Masterworks Russell Cook 17/17 XR-Right',
                default: true,
                bridges: [
                    {
                        name:'High treble',
                        notesRight: ['A6', 'G6', 'F#6', 'D#6', 'C#6', 'G#5'],
                        verticalOffset: 0,
                        markers: [0, 3] // A6, G6
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['F6', 'E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'A5', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [0, 3, 6, 9, 12, 15] // F6, F5, C5, G4, D4, A3, E3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['Eb5', 'D5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'A2'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Low Bass',
                        notesLeft: ['Bb3', 'F3', 'D#3', 'C3', 'B2', 'A2', 'G2', 'F#2', 'E2', 'D2'],
                        verticalOffset: 7, // 8 strings
                        markers: [0, 1, 3, 6,9] // Bb3, F3, C3, G2, D2, A1
                    }
                ]
            },
            {
                id: 'nick-blanton-compact-karen-ashbrook',
                name: 'Nick Blanton Compact Karen Ashbrook 2/16/15/7',
                default: true,
                bridges: [
                    {
                        name: 'Left Chromatic',
                        notesRight: ['D#6', 'C#6',],
                        verticalOffset: 0, // 10 strings
                        markers: [] // Mark white keys
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'G#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C#5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [2, 5, 8, 11, 14] // Bb4, F4, C4, G3, D3
                    },
                    {
                        name: 'Right Super Bass',
                        notesLeft: ['Bb3', 'F3', 'Eb3', 'C3', 'B2', 'A2', 'G2'],
                        verticalOffset: 7, // 10 strings
                        markers: [3,6] // Mark white keys
                    }
                ]
            },
            {
                id: 'rick-thum-pro-17-17',
                name: 'Rick Thum Pro 17/17',
                default: true,
                bridges: [
                    
                    {
                        name: 'Treble',
                        notesLeft: ['E6', 'D6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4', 'F3'],
                        notesRight: ['Bb6', 'G5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3', 'Bb2'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] // C6, G5, D5, A4, E4
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#5', 'C#5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3', 'A2', 'D2'],
                        verticalOffset: 0,
                        markers: [2,5,8,11,14] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            {
                id: 'songbird-finch-17-16',
                name: 'Songbird 17/16 Finch',
                default: true,
                bridges: [
                        {
                        name: 'Treble',
                        notesLeft: ['D#6', 'D6', 'C#6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'G#5', 'F#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // F5, C5, G4, D4, A3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#6', 'D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            {
                id: 'songbird-finch-17-16-8',
                name: 'Songbird 17/16/8 Finch Chromatic',
                default: true,
                bridges: [
                    {
                        name: 'Low Bass',
                        notesRight: ['Bb3', 'F3', 'D#3', 'C3', 'A2', 'G2', 'E2', 'D2'],
                        verticalOffset: 9, // 9 strings
                        markers: [1, 3, 6] // F3, C3, E2
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['D#6', 'D6', 'C#6', 'C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['Bb5', 'G#5', 'F#5', 'F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // F5, C5, G4, D4, A3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['D#6', 'D#5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [3, 6, 9, 12, 15] // Bb4, F4, C4, G3, D3
                    }
                ]
            },
            {
                id: 'songbird-voyager-14-13-6-7',
                name: 'Songbird 14/13/6/7 Chromatic',
                default: true,
                bridges: [
                    {
                        name: 'Chromatic/Low Bass',
                        notesRight: ['D6', 'Bb5', 'G#5', 'D#5', 'Bb3', 'F3', 'D#3', null, 'C3', 'A2', 'G2', 'F#2', 'E2', 'D2'],
                        verticalOffset: 0, // 9 strings
                        markers: [8, 10, 13] // F3, C3, E2
                    },
                    {
                        name: 'Treble',
                        notesLeft: ['C6', 'B5', 'A5', 'G5', 'F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'G#4', 'F#4', 'E4', 'D#4'],
                        notesRight: ['F5', 'E5', 'D5', 'C5', 'B4', 'A4', 'G4', 'F#4', 'E4', 'D4', 'C#4', 'B3', 'A3', 'G#3'],
                        verticalOffset: 0,
                        markers: [0,3, 6, 9, 12] // F5, C5, G4, D4, A3
                    },
                    {
                        name: 'Bass',
                        notesLeft: ['Bb4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4', 'B3', 'A3', 'G3', 'F#3', 'E3', 'D3'],
                        verticalOffset: 0,
                        markers: [0,3,6,9,12] // Bb4, F4, C4, G3, D3
                    }
                ]
            }
            // Add more instruments here in the future
        ];

        // Chord intervals (in semitones from root)
        const chordTypes = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            'diminished': [0, 3, 6],
            'augmented': [0, 4, 8],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            'power5': [0, 7],
            'major6': [0, 4, 7, 9],
            'minor6': [0, 3, 7, 9],
            'major7': [0, 4, 7, 11],
            'minor7': [0, 3, 7, 10],
            'dominant7': [0, 4, 7, 10],
            'diminished7': [0, 3, 6, 9],
            '7sus4': [0, 5, 7, 10],
            'minor7b5': [0, 3, 6, 10],
            '7b5': [0, 4, 6, 10],
            '7b9': [0, 4, 7, 10, 13],
            '7sharp9': [0, 4, 7, 10, 15],
            'major9': [0, 4, 7, 11, 14],
            'minor9': [0, 3, 7, 10, 14],
            'dominant9': [0, 4, 7, 10, 14],
            'add9': [0, 4, 7, 14],
            '6add9': [0, 4, 7, 9, 14],
            'major11': [0, 4, 7, 11, 14, 17],
            'minor11': [0, 3, 7, 10, 14, 17],
            'dominant11': [0, 4, 7, 10, 14, 17],
            'major13': [0, 4, 7, 11, 14, 21],
            'minor13': [0, 3, 7, 10, 14, 21],
            'dominant13': [0, 4, 7, 10, 14, 21]
        };

        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // Enharmonic equivalents map
        const enharmonicMap = {
            'C#': 'Db', 'Db': 'C#',
            'D#': 'Eb', 'Eb': 'D#',
            'F#': 'Gb', 'Gb': 'F#',
            'G#': 'Ab', 'Ab': 'G#',
            'A#': 'Bb', 'Bb': 'A#'
        };
        // Get current instrument
        let currentInstrument = null;
        
        // User preferences
        let sharpFlatPreference = 'sharp'; // 'sharp' or 'flat'
        let selectedKeySignature = 'none'; // Key signature selection

        // Note display conversion based on sharp/flat preference
        function convertNoteDisplay(note) {
            // Extract note name without octave
            const noteName = note.replace(/\d/g, '');
            const octave = note.match(/\d/g) ? note.match(/\d/g).join('') : '';
            
            if (sharpFlatPreference === 'flat') {
                // Convert sharps to flats
                const flatMap = {
                    'C#': 'Dâ™­',
                    'D#': 'Eâ™­',
                    'F#': 'Gâ™­',
                    'G#': 'Aâ™­',
                    'A#': 'Bâ™­'
                };
                const converted = flatMap[noteName] || noteName;
                // Replace any remaining # with â™­ for display
                return converted.replace(/#/g, 'â™¯').replace(/b/g, 'â™­') + octave;
            } else {
                // Convert flats to sharps
                const sharpMap = {
                    'Db': 'Câ™¯',
                    'Eb': 'Dâ™¯',
                    'Gb': 'Fâ™¯',
                    'Ab': 'Gâ™¯',
                    'Bb': 'Aâ™¯'
                };
                const converted = sharpMap[noteName] || noteName;
                // Replace any remaining # with â™¯ and b with â™­ for display
                return converted.replace(/#/g, 'â™¯').replace(/b/g, 'â™­') + octave;
            }
        }

        // Key signature definitions (notes in each key)
        const keySignatures = {
            // Major keys
            'C Major': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G Major': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
            'D Major': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
            'A Major': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
            'E Major': ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'],
            'B Major': ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'],
            'Fâ™¯ Major': ['F#', 'G#', 'A#', 'B', 'C#', 'D#', 'E#'],
            'Câ™¯ Major': ['C#', 'D#', 'E#', 'F#', 'G#', 'A#', 'B#'],
            'F Major': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
            'Bâ™­ Major': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
            'Eâ™­ Major': ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'],
            'Aâ™­ Major': ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'],
            'Dâ™­ Major': ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C'],
            'Gâ™­ Major': ['Gb', 'Ab', 'Bb', 'Cb', 'Db', 'Eb', 'F'],
            'Câ™­ Major': ['Cb', 'Db', 'Eb', 'Fb', 'Gb', 'Ab', 'Bb'],
            // Minor keys
            'A Minor': ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
            'E Minor': ['E', 'F#', 'G', 'A', 'B', 'C', 'D'],
            'B Minor': ['B', 'C#', 'D', 'E', 'F#', 'G', 'A'],
            'Fâ™¯ Minor': ['F#', 'G#', 'A', 'B', 'C#', 'D', 'E'],
            'Câ™¯ Minor': ['C#', 'D#', 'E', 'F#', 'G#', 'A', 'B'],
            'Gâ™¯ Minor': ['G#', 'A#', 'B', 'C#', 'D#', 'E', 'F#'],
            'Dâ™¯ Minor': ['D#', 'E#', 'F#', 'G#', 'A#', 'B', 'C#'],
            'Aâ™¯ Minor': ['A#', 'B#', 'C#', 'D#', 'E#', 'F#', 'G#'],
            'D Minor': ['D', 'E', 'F', 'G', 'A', 'Bb', 'C'],
            'G Minor': ['G', 'A', 'Bb', 'C', 'D', 'Eb', 'F'],
            'C Minor': ['C', 'D', 'Eb', 'F', 'G', 'Ab', 'Bb'],
            'F Minor': ['F', 'G', 'Ab', 'Bb', 'C', 'Db', 'Eb'],
            'Bâ™­ Minor': ['Bb', 'C', 'Db', 'Eb', 'F', 'Gb', 'Ab'],
            'Eâ™­ Minor': ['Eb', 'F', 'Gb', 'Ab', 'Bb', 'Cb', 'Db'],
            'Aâ™­ Minor': ['Ab', 'Bb', 'Cb', 'Db', 'Eb', 'Fb', 'Gb']
        };

        // Check if a note is in the selected key signature
        function isNoteInKeySignature(note) {
            if (selectedKeySignature === 'none') return false;
            
            // Extract note name without octave (handle both formats like "C#4" and "C#")
            const noteName = note.replace(/\d+/g, '');
            const keyNotes = keySignatures[selectedKeySignature];
            
            if (!keyNotes) return false;
            
            // Check if note is in key
            if (keyNotes.includes(noteName)) return true;
            
            // Check enharmonic equivalents
            if (enharmonicMap[noteName]) {
                return keyNotes.includes(enharmonicMap[noteName]);
            }
            
            return false;
        }

        // localStorage works with file:// protocol, unlike cookies
        function getSavedValue(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.warn('localStorage not available:', e);
                return null;
            }
        }

        function setSavedValue(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.warn('localStorage not available:', e);
            }
        }

        function getDefaultInstrument() {
            // Check localStorage first
            const savedId = getSavedValue('selectedInstrument');
            if (savedId) {
                const saved = instruments.find(i => i.id === savedId);
                if (saved) {
                    return saved;
                }
            }
            // Return null for fresh loads (will show placeholder)
            return null;
        }

        function populateInstrumentSelector() {
            const select = document.getElementById('instrument-select');
            select.innerHTML = '';
            
            // Add placeholder option
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Choose an instrument...';
            placeholder.disabled = true;
            placeholder.selected = currentInstrument === null;
            select.appendChild(placeholder);
            
            // Add instrument options
            instruments.forEach(instrument => {
                const option = document.createElement('option');
                option.value = instrument.id;
                option.textContent = instrument.name;
                if (currentInstrument && currentInstrument.id === instrument.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Add "Request a layout..." option
            const requestOption = document.createElement('option');
            requestOption.value = 'request-layout';
            requestOption.textContent = 'Request an instrument layout...';
            requestOption.className = 'request-layout-option';
            select.appendChild(requestOption);
        }

        function populateKeySignatureSelector() {
            const select = document.getElementById('key-signature-select');
            select.innerHTML = '<option value="none">None</option>';
            
            // Add major keys
            const majorKeys = ['C Major', 'G Major', 'D Major', 'A Major', 'E Major', 'B Major', 
                              'Fâ™¯ Major', 'Câ™¯ Major', 'F Major', 'Bâ™­ Major', 'Eâ™­ Major', 
                              'Aâ™­ Major', 'Dâ™­ Major', 'Gâ™­ Major', 'Câ™­ Major'];
            
            majorKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
            
            // Add minor keys
            const minorKeys = ['A Minor', 'E Minor', 'B Minor', 'Fâ™¯ Minor', 'Câ™¯ Minor', 'Gâ™¯ Minor',
                              'Dâ™¯ Minor', 'Aâ™¯ Minor', 'D Minor', 'G Minor', 'C Minor', 
                              'F Minor', 'Bâ™­ Minor', 'Eâ™­ Minor', 'Aâ™­ Minor'];
            
            minorKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }

       

        // Audio context for sound synthesis
        let audioContext;
        let soundfontPlayer;
        let isLoadingInstrument = false;
        let soundfontLoadFailed = false;
        let activeOscillators = [];
        let currentSoundBank = 'dulcimer'; // Default sound bank
        let audioUnlocked = false; // Track if audio is truly unlocked

        async function initAudio(forceReload = false) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // iOS Safari requires AudioContext to be resumed on user interaction
            if (audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('AudioContext resumed successfully');
                } catch (error) {
                    console.error('Failed to resume AudioContext:', error);
                    // Only show overlay for iOS devices
                    if (isIOS()) {
                        showAudioInitOverlay();
                    }
                }
            }
            
            // Get saved sound bank preference
            const savedSoundBank = getSavedValue('selectedSoundBank') || 'dulcimer';
            
            // Load soundfont if needed
            if ((!soundfontPlayer || forceReload || savedSoundBank !== currentSoundBank) && !isLoadingInstrument && !soundfontLoadFailed) {
                isLoadingInstrument = true;
                currentSoundBank = savedSoundBank;
                try {
                    // Load the selected soundfont
                    console.log(`Loading ${currentSoundBank} soundfont...`);
                    soundfontPlayer = await Soundfont.instrument(audioContext, currentSoundBank);
                    console.log(`${currentSoundBank} soundfont loaded successfully`);
                } catch (error) {
                    console.error(`Failed to load ${currentSoundBank} soundfont, will use fallback oscillator:`, error);
                    soundfontLoadFailed = true;
                } finally {
                    isLoadingInstrument = false;
                }
            }
        }

        async function changeSoundBank(soundBankId) {
            // Save the selection
            setSavedValue('selectedSoundBank', soundBankId);
            currentSoundBank = soundBankId;
            
            // Reset soundfont state
            soundfontPlayer = null;
            soundfontLoadFailed = false;
            
            // Reload with new sound bank
            await initAudio(true);
            
            // Update UI
            populateSoundBankList();
        }

        function showAudioInitOverlay() {
            const overlay = document.getElementById('audio-init-overlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideAudioInitOverlay() {
            const overlay = document.getElementById('audio-init-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        async function unlockAudio() {
            // FORCE create a new AudioContext in this user gesture
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('[DEBUG] New AudioContext created, initial state:', audioContext.state);
            
            // MUST resume on iOS - this is critical
            await audioContext.resume();
            
            // Verify it's actually running
            if (audioContext.state !== 'running') {
                console.error('[DEBUG] AudioContext failed to reach running state:', audioContext.state);
                return;
            }
            
            // Play a brief unlock tone (silent on success)
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0.001; // Nearly silent
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 440;
            oscillator.type = 'sine';
            
            const now = audioContext.currentTime;
            oscillator.start(now);
            oscillator.stop(now + 0.1);
            
            // Mark as unlocked
            audioUnlocked = true;
            
            // Now load soundfont
            await initAudio(true);
            
            hideAudioInitOverlay();
        }

        function getFrequency(noteName) {
            const match = noteName.match(/([A-G][#b]?)(\d)/);
            if (!match) {
                console.warn(`Invalid note format: "${noteName}"`);
                return null;
            }
            let note = match[1];
            const octave = parseInt(match[2]);
            
            // Convert flat notes to sharp equivalents for frequency lookup
            if (note.includes('b')) {
                const sharpEquivalent = enharmonicMap[note];
                if (sharpEquivalent) {
                    note = sharpEquivalent;
                } else {
                    console.warn(`Unknown flat note: "${note}" in "${noteName}"`);
                    return null;
                }
            }
            
            const frequency = noteFrequencies[note]?.[octave];
            if (!frequency) {
                console.warn(`No frequency found for note: "${noteName}" (parsed as ${note}${octave})`);
                return null;
            }
            
            return frequency;
        }

        function playNoteWithOscillator(noteName, duration = 1.0) {
            // Fallback: Use triangle wave oscillator
            const frequency = getFrequency(noteName);
            if (frequency === null) {
                return;
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'triangle'; // Dulcimer-like sound
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            activeOscillators.push(oscillator);
            
            setTimeout(() => {
                const index = activeOscillators.indexOf(oscillator);
                if (index > -1) activeOscillators.splice(index, 1);
            }, duration * 1000);
        }

        async function playNote(noteName, duration = 1.0) {
            
            // Try to auto-initialize on first play if not yet unlocked
            if (!audioUnlocked && !audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    await audioContext.resume();
                    
                    if (audioContext.state === 'running') {
                        // Success! Desktop browser
                        audioUnlocked = true;
                        // Start loading soundfont
                        initAudio();
                    } else {
                        // Failed - need user gesture (iOS/mobile)
                        showAudioInitOverlay();
                        return;
                    }
                } catch (error) {
                    showAudioInitOverlay();
                    return;
                }
            } else if (!audioUnlocked) {
                // Audio exists but not unlocked - show overlay
                showAudioInitOverlay();
                return;
            }
            
            // Initialize audio if not already done
            if (!audioContext) {
                await initAudio();
            }
            
            // If soundfont is still loading, wait for it to finish
            if (isLoadingInstrument) {
                console.log('Waiting for soundfont to load...');
                // Wait up to 5 seconds for soundfont to load
                const maxWaitTime = 5000;
                const startTime = Date.now();
                while (isLoadingInstrument && (Date.now() - startTime) < maxWaitTime) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Use soundfont if available, otherwise fall back to oscillator
            if (soundfontPlayer) {
                try {
                    // Soundfont.js uses note names like "C4", "A#5", etc.
                    // Convert flat notes to sharp for compatibility
                    let processedNote = noteName;
                    if (noteName.includes('b')) {
                        const match = noteName.match(/([A-G])b(\d)/);
                        if (match) {
                            const flatNote = match[1] + 'b';
                            const octave = match[2];
                            const sharpEquivalent = enharmonicMap[flatNote];
                            if (sharpEquivalent) {
                                processedNote = sharpEquivalent + octave;
                            }
                        }
                    }
                    
                    soundfontPlayer.play(processedNote, audioContext.currentTime, {
                        duration: duration,
                        gain: config.note_gain  // Volume (0.0 to 1.0)
                    });
                } catch (error) {
                    console.error(`Error playing note ${noteName} with soundfont, falling back to oscillator:`, error);
                    playNoteWithOscillator(noteName, duration);
                }
            } else if (soundfontLoadFailed) {
                // Soundfont failed to load, use oscillator fallback
                playNoteWithOscillator(noteName, duration);
            } else {
                // Soundfont still not loaded after waiting, use oscillator fallback
                console.warn('Soundfont not loaded yet, using oscillator fallback...');
                playNoteWithOscillator(noteName, duration);
            }
        }

        function stopAllNotes() {
            if (soundfontPlayer) {
                soundfontPlayer.stop();
            }
            activeOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            activeOscillators = [];
        }

        function createValidationWarningBanner(errors, instrumentName) {
            const banner = document.createElement('div');
            banner.className = 'validation-warning-banner';
            
            const heading = document.createElement('h3');
            heading.innerHTML = `<span class="warning-icon">âš ï¸</span> Configuration Warnings`;
            banner.appendChild(heading);
            
            const description = document.createElement('p');
            description.textContent = 'The following issues were found in this instrument configuration:';
            description.style.margin = '0 0 5px 0';
            banner.appendChild(description);
            
            const errorList = document.createElement('ul');
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            banner.appendChild(errorList);
            
            const footer = document.createElement('p');
            footer.textContent = 'The instrument will still render, but some features may not work correctly.';
            footer.style.margin = '10px 0 0 0';
            footer.style.fontSize = '0.85rem';
            footer.style.fontStyle = 'italic';
            banner.appendChild(footer);
            
            return banner;
        }

        function buildDulcimer() {
            const container = document.getElementById('dulcimer');
            container.innerHTML = '';
            
            // If no instrument selected, show placeholder message
            if (!currentInstrument) {
                const message = document.createElement('div');
                message.className = 'no-instrument-message';
                message.textContent = 'Please select an instrument to begin';
                container.appendChild(message);
                return;
            }

            // Validate current instrument and show warning banner if needed
            const validation = validateInstrument(currentInstrument);
            if (!validation.valid) {
                const warningBanner = createValidationWarningBanner(validation.errors, currentInstrument.name);
                container.appendChild(warningBanner);
                console.warn(`Instrument "${currentInstrument.name}" has configuration warnings:`, validation.errors);
            }

            // Get current string spacing from CSS variable
            const stringSpacing = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--string-spacing'));

            currentInstrument.bridges.forEach(bridgeConfig => {
                const section = document.createElement('div');
                section.className = 'bridge-container';
                
                const label = document.createElement('div');
                label.className = 'bridge-label';
                label.textContent = bridgeConfig.name;
                section.appendChild(label);
                
                const bridgeSection = document.createElement('div');
                bridgeSection.className = 'bridge-section';
                
                // Calculate vertical offset in pixels from string count
                const verticalOffsetPx = bridgeConfig.verticalOffset * stringSpacing;
                
                // Add special class for bridges with vertical offset
                if (bridgeConfig.verticalOffset > 0) {
                    bridgeSection.classList.add('low-bass');
                }
                
                const bridge = document.createElement('div');
                bridge.className = 'bridge bridge-middle';
                
                // Determine which notes array to use for markers
                const notesForMarkers = bridgeConfig.notesRight || bridgeConfig.notesLeft;
                
                // Add markers
                if (bridgeConfig.markers && bridgeConfig.markers.length > 0 && notesForMarkers) {
                    bridgeConfig.markers.forEach(idx => {
                        if (idx < notesForMarkers.length) {
                            const marker = document.createElement('div');
                            marker.className = 'bridge-marker';
                            marker.style.top = (verticalOffsetPx + idx * stringSpacing + markerOffset) + 'px';
                            bridge.appendChild(marker);
                        }
                    });
                }
                
                // Build left strings if present
                if (bridgeConfig.notesLeft) {
                    const leftStrings = document.createElement('div');
                    leftStrings.className = 'strings-column strings-left';
                    if (bridgeConfig.verticalOffset > 0) {
                        leftStrings.style.paddingTop = verticalOffsetPx + 'px';
                    }
                    
                    bridgeConfig.notesLeft.forEach((note, index) => {
                        const bridgeName = bridgeConfig.name.toLowerCase().replace(' ', '');
                        const string = createString(note, bridgeName + 'Left', index);
                        leftStrings.appendChild(string);
                    });
                    
                    bridgeSection.appendChild(leftStrings);
                }
                
                // Add the bridge itself
                bridgeSection.appendChild(bridge);
                
                // Build right strings if present
                if (bridgeConfig.notesRight) {
                    const rightStrings = document.createElement('div');
                    rightStrings.className = 'strings-column strings-right';
                    if (bridgeConfig.verticalOffset > 0) {
                        rightStrings.style.paddingTop = verticalOffsetPx + 'px';
                    }
                    
                    bridgeConfig.notesRight.forEach((note, index) => {
                        const bridgeName = bridgeConfig.name.toLowerCase().replace(' ', '');
                        const string = createString(note, bridgeName + 'Right', index);
                        rightStrings.appendChild(string);
                    });
                    
                    bridgeSection.appendChild(rightStrings);
                }
                
                section.appendChild(bridgeSection);
                container.appendChild(section);
            });
        }

        function createString(note, bridge, index) {
            // Handle empty cells - return an invisible spacer element
            if (!note || note === '') {
                const spacer = document.createElement('div');
                spacer.className = 'string-spacer';
                spacer.style.height = 'var(--string-height)';
                spacer.style.width = '65px';
                spacer.style.visibility = 'hidden';
                return spacer;
            }
            
            const string = document.createElement('div');
            string.className = 'string';
            string.dataset.note = note;
            string.dataset.bridge = bridge;
            string.dataset.index = index;
            
            // Add key signature class if note is in selected key
            if (isNoteInKeySignature(note)) {
                string.classList.add('in-key-signature');
            }
            
            const label = document.createElement('div');
            label.className = 'note-label';
            // Convert note display based on sharp/flat preference
            label.textContent = convertNoteDisplay(note);
            string.appendChild(label);
            
            string.addEventListener('click', async () => {
                await playNote(note, 0.8);
            });
            
            return string;
        }

        function getChordNotes(root, type) {
            const rootIndex = noteNames.indexOf(root);
            const intervals = chordTypes[type];
            return intervals.map(interval => noteNames[(rootIndex + interval) % 12]);
        }

        function updateChordDisplay(chordIndex) {
            const chordState = chordStates[chordIndex];
            
            // Convert notes to use sharp/flat symbols for display
            const displayNotes = chordState.notes.map(note => note.replace(/#/g, 'â™¯').replace(/b/g, 'â™­'));
            
            document.getElementById(`chord-notes-${chordIndex + 1}`).textContent = 'Notes: ' + displayNotes.join(', ');
        }

        function updateAllHighlights() {
            // If no instrument selected, skip highlighting
            if (!currentInstrument) {
                return;
            }
            
            // Count how many chords are active
            const activeChordCount = chordStates.filter(c => c.active).length;
            
            // Clear all chord-related classes but preserve in-key-signature class
            document.querySelectorAll('.string').forEach(string => {
                const hasKeySignature = string.classList.contains('in-key-signature');
                string.className = 'string'; // Reset to base class
                if (hasKeySignature) {
                    string.classList.add('in-key-signature');
                }
            });
            
            // For each string, check membership in active chords
            document.querySelectorAll('.string').forEach(string => {
                const noteName = string.dataset.note.replace(/\d/, '');
                const memberChords = [];
                
                // Check each active chord
                chordStates.forEach((chordState, index) => {
                    if (chordState.active) {
                        const isMatch = chordState.notes.includes(noteName) || 
                                       (enharmonicMap[noteName] && chordState.notes.includes(enharmonicMap[noteName]));
                        if (isMatch) {
                            memberChords.push(index + 1); // 1-indexed for CSS classes
                        }
                    }
                });
                
                // Apply appropriate CSS class based on membership and active chord count
                if (memberChords.length === 0) {
                    // No chords match, leave as default
                    return;
                }
                
                if (activeChordCount === 1) {
                    // Only one chord active - full color
                    string.classList.add(`chord-${memberChords[0]}`);
                } else if (activeChordCount === 2) {
                    // Two chords active - use 1/4 segments
                    if (memberChords.length === 1) {
                        string.classList.add(`chord-${memberChords[0]}-only-of-2`);
                    } else if (memberChords.length === 2) {
                        string.classList.add(`chord-${memberChords[0]}-${memberChords[1]}-of-2`);
                    }
                } else if (activeChordCount === 3) {
                    // Three chords active - use 1/4 segments
                    if (memberChords.length === 1) {
                        string.classList.add(`chord-${memberChords[0]}-only-of-3`);
                    } else if (memberChords.length === 2) {
                        string.classList.add(`chord-${memberChords[0]}-${memberChords[1]}-of-3`);
                    } else if (memberChords.length === 3) {
                        string.classList.add('chord-1-2-3-of-3');
                    }
                }
            });
        }

        function highlightChord(chordIndex) {
            const chordState = chordStates[chordIndex];
            chordState.notes = getChordNotes(chordState.root, chordState.type);
            
            // Update chord display
            updateChordDisplay(chordIndex);
            
            // Update all string highlights
            updateAllHighlights();
        }

        async function playChord(chordIndex, delayMs = 50) {
            // Get strings that belong to this specific chord
            const chordClassName = `chord-${chordIndex + 1}`;
            const allStrings = document.querySelectorAll('.string');
            const chordStrings = Array.from(allStrings).filter(string => {
                // Check if this string has the chord class (alone or in combination)
                return string.classList.contains(chordClassName) ||
                       Array.from(string.classList).some(cls => cls.includes(`chord-`) && cls.includes(`${chordIndex + 1}`));
            });
            
            const allNotes = chordStrings.map(s => s.dataset.note);
            
            // Get unique notes (only one instance of each specific note with octave)
            const uniqueNotes = [...new Set(allNotes)];
            
            // Sort notes from low to high by frequency
            uniqueNotes.sort((a, b) => {
                const freqA = getFrequency(a);
                const freqB = getFrequency(b);
                // Handle null frequencies by putting them at the end
                if (freqA === null) return 1;
                if (freqB === null) return -1;
                return freqA - freqB;
            });
            
            // Initialize audio context once before playing
            await initAudio();
            
            // Play notes with delay for arpeggio effect
            uniqueNotes.forEach((note, index) => {
                setTimeout(() => playNote(note, 1.5), index * delayMs);
            });
        }

        // Show/Hide chord selector functions
        function showChordSelector(index) {
            const selector = document.querySelector(`.chord-selector[data-chord-index="${index}"]`);
            if (selector) {
                selector.classList.remove('hidden');
                chordStates[index].active = true;
                setSavedValue(`chord${index + 1}Active`, 'true');
                highlightChord(index);
                
                // Update + button visibility
                updateAddButtonVisibility();
            }
        }

        function hideChordSelector(index) {
            // Get list of active chord indices
            const activeIndices = chordStates
                .map((c, i) => c.active ? i : -1)
                .filter(i => i !== -1);
            
            // Find position of this chord in the active list
            const positionInActiveList = activeIndices.indexOf(index);
            
            if (positionInActiveList === -1) {
                return; // Chord is already inactive
            }
            
            // Shift chords after this one up
            for (let i = positionInActiveList; i < activeIndices.length - 1; i++) {
                const currentIndex = activeIndices[i];
                const nextIndex = activeIndices[i + 1];
                
                // Copy state from next chord to current chord
                chordStates[currentIndex].root = chordStates[nextIndex].root;
                chordStates[currentIndex].type = chordStates[nextIndex].type;
                chordStates[currentIndex].notes = chordStates[nextIndex].notes;
                
                // Update UI for current chord
                document.getElementById(`root-note-${currentIndex + 1}`).value = chordStates[currentIndex].root;
                document.getElementById(`chord-type-${currentIndex + 1}`).value = chordStates[currentIndex].type;
                updateChordDisplay(currentIndex);
                
                // Save the shifted state to localStorage
                setSavedValue(`selectedRootNote${currentIndex + 1}`, chordStates[currentIndex].root);
                setSavedValue(`selectedChordType${currentIndex + 1}`, chordStates[currentIndex].type);
            }
            
            // Deactivate the last active chord
            const lastActiveIndex = activeIndices[activeIndices.length - 1];
            chordStates[lastActiveIndex].active = false;
            setSavedValue(`chord${lastActiveIndex + 1}Active`, 'false');
            
            const selector = document.querySelector(`.chord-selector[data-chord-index="${lastActiveIndex}"]`);
            if (selector) {
                selector.classList.add('hidden');
            }
            
            // Update all highlights
            updateAllHighlights();
            
            // Update button visibility
            updateAddButtonVisibility();
        }

        function updateAddButtonVisibility() {
            const addBtnContainer = document.getElementById('add-chord-btn-container');
            
            // Count active chords
            const activeCount = chordStates.filter(c => c.active).length;
            
            // Hide + button if all 3 chords are active
            if (activeCount >= 3) {
                addBtnContainer.classList.add('hidden');
            } else {
                addBtnContainer.classList.remove('hidden');
            }
            
            // All remove buttons are always enabled (allow removing all chords)
            for (let i = 0; i < 3; i++) {
                const removeBtn = document.getElementById(`remove-chord-${i + 1}-btn`);
                if (removeBtn) {
                    removeBtn.disabled = false;
                }
            }
        }

        // Validate instrument configuration
        function validateInstrument(instrument) {
            if (!instrument) {
                return { valid: true }; // No instrument selected is valid
            }

            const errors = [];
            
            // Check if instrument has bridges array
            if (!instrument.bridges || !Array.isArray(instrument.bridges)) {
                errors.push(`Instrument "${instrument.name}" is missing the "bridges" array.`);
                return { valid: false, errors };
            }

            if (instrument.bridges.length === 0) {
                errors.push(`Instrument "${instrument.name}" has no bridges defined.`);
                return { valid: false, errors };
            }

            // Validate each bridge
            instrument.bridges.forEach((bridge, index) => {
                const bridgeName = bridge.name || `Bridge ${index + 1}`;
                const bridgeErrors = [];

                // Check for required name property
                if (!bridge.name || typeof bridge.name !== 'string') {
                    bridgeErrors.push(`Bridge ${index + 1} is missing a valid "name" property.`);
                }

                // Check for notes (either notesLeft or notesRight must be present)
                if (!bridge.notesLeft && !bridge.notesRight) {
                    bridgeErrors.push(`"${bridgeName}" has no notes defined (missing both "notesLeft" and "notesRight").`);
                }

                // Check for verticalOffset property (must be present, can be 0)
                if (bridge.verticalOffset === undefined || bridge.verticalOffset === null) {
                    bridgeErrors.push(`"${bridgeName}" is missing the "verticalOffset" property (should be a number, 0 if no offset needed).`);
                } else if (typeof bridge.verticalOffset !== 'number' || isNaN(bridge.verticalOffset)) {
                    bridgeErrors.push(`"${bridgeName}" has an invalid "verticalOffset" value (must be a number, got: ${bridge.verticalOffset}).`);
                }

                // Validate notesLeft if present
                if (bridge.notesLeft) {
                    if (!Array.isArray(bridge.notesLeft)) {
                        bridgeErrors.push(`"${bridgeName}" notesLeft is not an array.`);
                    } else if (bridge.notesLeft.length === 0) {
                        bridgeErrors.push(`"${bridgeName}" notesLeft array is empty.`);
                    }
                    // Note: Empty strings/null values are now allowed for spacing
                }

                // Validate notesRight if present
                if (bridge.notesRight) {
                    if (!Array.isArray(bridge.notesRight)) {
                        bridgeErrors.push(`"${bridgeName}" notesRight is not an array.`);
                    } else if (bridge.notesRight.length === 0) {
                        bridgeErrors.push(`"${bridgeName}" notesRight array is empty.`);
                    }
                    // Note: Empty strings/null values are now allowed for spacing
                }

                // Validate markers if present
                if (bridge.markers !== undefined) {
                    if (!Array.isArray(bridge.markers)) {
                        bridgeErrors.push(`"${bridgeName}" markers is not an array.`);
                    } else {
                        const notesArray = bridge.notesRight || bridge.notesLeft;
                        if (notesArray) {
                            const invalidMarkers = bridge.markers.filter(idx => 
                                typeof idx !== 'number' || idx < 0 || idx >= notesArray.length
                            );
                            if (invalidMarkers.length > 0) {
                                bridgeErrors.push(`"${bridgeName}" has invalid marker indices: ${invalidMarkers.join(', ')} (must be between 0 and ${notesArray.length - 1}).`);
                            }
                        }
                    }
                }

                if (bridgeErrors.length > 0) {
                    errors.push(...bridgeErrors);
                }
            });

            if (errors.length > 0) {
                return { valid: false, errors };
            }

            return { valid: true };
        }

        // Event listeners for all chords (consolidated loop)
        for (let i = 0; i < 3; i++) {
            const chordNum = i + 1;
            
            document.getElementById(`root-note-${chordNum}`).addEventListener('change', (e) => {
                chordStates[i].root = e.target.value;
                setSavedValue(`selectedRootNote${chordNum}`, e.target.value);
                highlightChord(i);
            });
            
            document.getElementById(`chord-type-${chordNum}`).addEventListener('change', (e) => {
                chordStates[i].type = e.target.value;
                setSavedValue(`selectedChordType${chordNum}`, e.target.value);
                highlightChord(i);
            });
            
            document.getElementById(`play-chord-${chordNum}-fast`).addEventListener('click', () => playChord(i, 100));
            document.getElementById(`play-chord-${chordNum}-slow`).addEventListener('click', () => playChord(i, 500));
            document.getElementById(`remove-chord-${chordNum}-btn`).addEventListener('click', () => hideChordSelector(i));
        }

        // Add chord button
        document.getElementById('add-chord-btn').addEventListener('click', () => {
            // Find first inactive chord and show it
            const inactiveIndex = chordStates.findIndex(c => !c.active);
            if (inactiveIndex !== -1) {
                showChordSelector(inactiveIndex);
            }
        });

        // Sharp/Flat selector
        document.getElementById('sharp-flat-select').addEventListener('change', (e) => {
            sharpFlatPreference = e.target.value;
            setSavedValue('sharpFlatPreference', sharpFlatPreference);
            
            // Rebuild the dulcimer to update all note labels
            buildDulcimer();
            updateAllHighlights();
        });

        // Key Signature selector
        document.getElementById('key-signature-select').addEventListener('change', (e) => {
            selectedKeySignature = e.target.value;
            setSavedValue('selectedKeySignature', selectedKeySignature);
            
            // Rebuild the dulcimer to update key signature highlighting
            buildDulcimer();
            updateAllHighlights();
        });

        document.getElementById('instrument-select').addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            
            // Check if "Request a layout..." was selected
            if (selectedValue === 'request-layout') {
                // Navigate to the Google Form URL from config
                if (typeof config !== 'undefined' && config.googleFormUrl) {
                    window.open(config.googleFormUrl, '_blank');
                } else {
                    alert('Google Form URL is not configured. Please check the config.js file.');
                }
                
                // Reset the selection to the previous instrument or placeholder
                // Note: We intentionally do NOT save this selection to localStorage
                e.target.value = currentInstrument ? currentInstrument.id : '';
                return; // Exit early - do not save or process this selection
            }
            
            // Handle normal instrument selection - save to localStorage
            const selectedInstrument = instruments.find(i => i.id === selectedValue);
            
            // Log validation errors to console, but proceed with selection
            // (warnings will be displayed in a banner in the buildDulcimer function)
            const validation = validateInstrument(selectedInstrument);
            if (!validation.valid) {
                console.warn(`Selected instrument "${selectedInstrument.name}" has configuration warnings:`, validation.errors);
            }
            
            // Proceed with selection (warnings will be shown in banner if any)
            currentInstrument = selectedInstrument;
            setSavedValue('selectedInstrument', selectedValue);
            buildDulcimer();
            updateAllHighlights();
        });

        // Rebuild dulcimer on window resize to adjust marker positions
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                buildDulcimer();
                updateAllHighlights();
            }, 250);
        });

        // Initialize
        currentInstrument = getDefaultInstrument();
        
        // Restore sharp/flat preference
        const savedSharpFlat = getSavedValue('sharpFlatPreference');
        if (savedSharpFlat) {
            sharpFlatPreference = savedSharpFlat;
            document.getElementById('sharp-flat-select').value = sharpFlatPreference;
        }
        
        // Restore key signature preference
        const savedKeySignature = getSavedValue('selectedKeySignature');
        if (savedKeySignature) {
            // Convert old format to new format with symbols
            selectedKeySignature = savedKeySignature.replace(/#/g, 'â™¯').replace(/b/g, 'â™­');
        }
        
        // Populate key signature selector
        populateKeySignatureSelector();
        
        // Set the saved key signature selection
        if (savedKeySignature) {
            const convertedValue = savedKeySignature.replace(/#/g, 'â™¯').replace(/b/g, 'â™­');
            document.getElementById('key-signature-select').value = convertedValue;
        }
        
        // Note: Audio initialization is deferred until first user interaction
        // to avoid browser autoplay policy warnings. Audio will be initialized
        // automatically when user clicks a note or the play button.
        
        // Log validation warnings for the default instrument
        // (warnings will be displayed in a banner in the buildDulcimer function)
        if (currentInstrument) {
            const validation = validateInstrument(currentInstrument);
            if (!validation.valid) {
                console.warn(`Default instrument "${currentInstrument.name}" has configuration warnings:`, validation.errors);
            }
        }
        
        populateInstrumentSelector();
        
        // Restore saved chord states for all 3 chords
        for (let i = 0; i < 3; i++) {
            const chordNum = i + 1;
            
            // Restore root note
            const savedRootNote = getSavedValue(`selectedRootNote${chordNum}`);
            if (savedRootNote) {
                const rootNoteSelect = document.getElementById(`root-note-${chordNum}`);
                const option = Array.from(rootNoteSelect.options).find(opt => opt.value === savedRootNote);
                if (option) {
                    rootNoteSelect.value = savedRootNote;
                    chordStates[i].root = savedRootNote;
                }
            }
            
            // Restore chord type
            const savedChordType = getSavedValue(`selectedChordType${chordNum}`);
            if (savedChordType) {
                const chordTypeSelect = document.getElementById(`chord-type-${chordNum}`);
                const option = Array.from(chordTypeSelect.options).find(opt => opt.value === savedChordType);
                if (option) {
                    chordTypeSelect.value = savedChordType;
                    chordStates[i].type = savedChordType;
                }
            }
            
            // Restore active state (including chord 1)
            const savedActive = getSavedValue(`chord${chordNum}Active`);
            if (savedActive === 'false') {
                // Explicitly set to inactive and hide
                chordStates[i].active = false;
                const selector = document.querySelector(`.chord-selector[data-chord-index="${i}"]`);
                if (selector) {
                    selector.classList.add('hidden');
                }
            } else if (savedActive === 'true' || i === 0) {
                // Set to active (chord 1 defaults to active if no saved state)
                chordStates[i].active = true;
                const selector = document.querySelector(`.chord-selector[data-chord-index="${i}"]`);
                if (selector) {
                    selector.classList.remove('hidden');
                }
            }
            
            // Calculate notes for this chord
            chordStates[i].notes = getChordNotes(chordStates[i].root, chordStates[i].type);
            
            // Update chord display
            updateChordDisplay(i);
        }
        
        buildDulcimer();
        updateAllHighlights();
        updateAddButtonVisibility();

        // Detect if running on iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Try to auto-unlock audio on page load (works on desktop, requires user gesture on iOS)
        (async function tryAutoUnlock() {
            const iOS = isIOS();
            
            try {
                const testContext = new (window.AudioContext || window.webkitAudioContext)();
                await testContext.resume();
                
                // If we get here with running state, audio works without user interaction (desktop)
                if (testContext.state === 'running') {
                    console.log('[DEBUG] Audio auto-unlocked - desktop browser detected');
                    audioContext = testContext;
                    audioUnlocked = true;
                    // Load soundfont in background
                    initAudio();
                } else {
                    console.log('[DEBUG] Audio requires user interaction - mobile browser');
                    testContext.close();
                    
                    // Only show iOS overlay if actually on iOS
                    if (iOS) {
                        showAudioInitOverlay();
                    }
                }
            } catch (error) {
                console.log('[DEBUG] Auto-unlock failed, will require user interaction:', error);
                
                // Only show iOS overlay if actually on iOS
                if (iOS) {
                    showAudioInitOverlay();
                }
            }
        })();

        // Sound Bank Modal Management
        function populateSoundBankList() {
            const soundBankList = document.getElementById('sound-bank-list');
            const selectedSoundBank = getSavedValue('selectedSoundBank') || 'dulcimer';
            
            soundBankList.innerHTML = '';
            
            // Group sound banks by category
            const categories = [...new Set(soundBanks.map(sb => sb.category))];
            
            categories.forEach(category => {
                // Create category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'sound-bank-category-header';
                categoryHeader.textContent = category;
                soundBankList.appendChild(categoryHeader);
                
                // Add instruments for this category
                const categoryBanks = soundBanks.filter(sb => sb.category === category);
                
                categoryBanks.forEach(soundBank => {
                    const item = document.createElement('div');
                    item.className = 'sound-bank-item';
                    if (soundBank.id === selectedSoundBank) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div class="sound-bank-name">${soundBank.name}</div>
                    `;
                    
                    item.addEventListener('click', async () => {
                        // Close modal
                        document.getElementById('sound-bank-modal').classList.remove('active');
                        
                        // Change sound bank
                        await changeSoundBank(soundBank.id);
                    });
                    
                    soundBankList.appendChild(item);
                });
            });
        }

        // Sound bank modal event listeners - wrapped to ensure DOM is ready
        function initSoundBankModal() {
            const soundBankButton = document.getElementById('sound-bank-button');
            const soundBankModal = document.getElementById('sound-bank-modal');
            const modalCloseButton = document.getElementById('modal-close-button');
            
            if (soundBankButton && soundBankModal && modalCloseButton) {
                // Sound bank button event listener
                soundBankButton.addEventListener('click', () => {
                    populateSoundBankList();
                    soundBankModal.classList.add('active');
                });

                // Modal close button event listener
                modalCloseButton.addEventListener('click', () => {
                    soundBankModal.classList.remove('active');
                });

                // Close modal when clicking outside
                soundBankModal.addEventListener('click', (e) => {
                    if (e.target.id === 'sound-bank-modal') {
                        soundBankModal.classList.remove('active');
                    }
                });

                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        soundBankModal.classList.remove('active');
                    }
                });
            }
        }

        // Initialize sound bank modal when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSoundBankModal);
        } else {
            // DOM already loaded
            initSoundBankModal();
        }

        // Audio initialization button for iOS
        const audioInitButton = document.getElementById('audio-init-button');
        if (audioInitButton) {
            audioInitButton.addEventListener('click', unlockAudio);
        }

        // Allow spacebar to play chord 1 (fast)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                playChordFast(0);
            }
        });
    </script>

    <!-- Sound Bank Modal -->
    <div id="sound-bank-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Sound Bank</h2>
                <button class="modal-close" id="modal-close-button">&times;</button>
            </div>
            <div class="sound-bank-list" id="sound-bank-list">
                <!-- Sound banks will be populated here by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>
